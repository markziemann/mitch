---
title: "mitch Workflow"
author: "Mark Ziemann & Antony Kaspi"
date: "`r Sys.Date()`"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{mitch Workflow}
  %\VignetteEngine{knitr::rmarkdown}
  \usepackage[utf8]{inputenc}
---

# mitch workflow
## Background

mitch is an R package for multi-dimensional enrichment analysis.
At it's heart, it uses a rank-MANOVA based statistical approach to
detect sets of genes that exhibit enrichment in the multidimensional
space as compared to the background. The rank-MANOVA concept dates to
work by Cox and Mann (https://doi.org/10.1186/1471-2105-13-S16-S12).
mitch is useful for pathway analysis of profiling studies with one,
two to or more contrasts, or in studies with multiple omics profiling,
for example proteomic, transcriptomic, epigenomic analysis of the same
samples. mitch is perfectly suited for pathway level differential
analysis of scRNA-seq data.

The main strengths of mitch are that it can import datasets easily
from many upstream tools and has advanced plotting features to 
visualise these enrichment. mitch consists of five functions. A
typical mitch workflow would consists of: 
    *1: Import gene sets with gmt_import()
    *2: Import profiling data with mitch_import()
    *3: Calculate enrichments with mitch_calc()
    *4: And generate plots and reports with mitch_plots() and mitch_report()


```{r, lib1, eval = FALSE, include = TRUE}
if(!requireNamespace("BiocManager", quietly = TRUE))
    install.packages("BiocManager")
BiocManager::install("mitch")
library("mitch")
```

## Workflow overview
Importing gene sets
mitch has a function to import GMT files to R lists (adapted from Yu et al, 2012 in the clusterProfiler package). 
For example we can grab some gene sets from Reactome.org:

```{r,gsets}
download.file("https://reactome.org/download/current/ReactomePathways.gmt.zip",destfile="ReactomePathways.gmt.zip")
unzip("ReactomePathways.gmt.zip")
genesets<-gmt_import("ReactomePathways.gmt")
genesets<-head(genesets,20)
```

## Importing profiling data
mitch accepts pre-ranked data supplied by the user, but also has a function called mitch_import for importing 
tables generated by Limma, edgeR, DESeq2, ABSSeq, Sleuth, Seurat and Muscat. By default, only the genes that are 
detected in all contrasts are included, but this behaviour can be modified. The below example imports two DESeq2 
tables called "dge1" and "dge2" Where gene identifiers are coded in the row names.

```{r,import11,echo=FALSE}
dge1<-read.table("https://raw.githubusercontent.com/markziemann/mitch/master/data-raw/LGvHG.tsv",header=TRUE,row.names=1)
```
```{r,import12,echo=FALSE}
dge2<-read.table("https://raw.githubusercontent.com/markziemann/mitch/master/data-raw/HGvHGV.tsv",header=TRUE,row.names=1)
```
```{r,import13,echo=FALSE}
gt<-read.table("https://raw.githubusercontent.com/markziemann/mitch/master/data-raw/gt.tsv",header=TRUE,row.names=1)
```

```{r,import21}
x<-list("dge1"=dge1,"dge2"=dge2)
```

```{r,import22,echo=FALSE}
y<-mitch_import(x,"deseq2")
```

mitch can do unidimensional analysis if you provide it a single profile as a dataframe.

```{r,import4,eval=FALSE}
y<-mitch_import(df,DEtype="deseq2")
```

If the gene identifiers are not given in the rownames, then the column can be specified with the geneIDcol 
parameter like this:

```{r,import5,eval=FALSE}
y<-mitch_import(df,DEtype="deseq2",geneIDcol="MyGeneIDs")
```

By default, differential gene activity is scored using the directional nominal p-value.

S = -log10(p-value) * sgn(logFC)

If this is not desired, then users can perform their own custom scoring procedure.

There are many cases where the gene IDs don't match the gene sets. To overcome this, mitch_import also accepts a 
two-column table (gt here) that relates gene identifiers in the profiling data to those in the gene sets.

```{r,import6}
head(dge1,3)
head(dge2,3)
head(gt,3)
x<-list("dge1"=dge1,"dge2"=dge2)
y<-mitch_import(x,DEtype="deseq2",geneTable=gt)
head(y,3)
```

`?mitch_import` provides more instructions on using this feature.

## Calculating enrichment
The mitch_calc function performs multivariate enrichment analysis of the supplied gene sets in the scored 
profiling data. At its simpest form mitch_calc function accepts the scored data as the first argument and the 
genesets as the second argument. Users can prioritise enrichments based on small adjusted p-values, or by the 
observed effect size (magnitude of the enrichment score). Note that the number of parallel cores is set here 
with cores=2 here but the default is to use all but one available cores.

```{r,calc1,eval=FALSE}
res<-mitch_calc(y,genesets,priority="significance",cores=2)
```

```{r,calc2,eval=TRUE}
res<-mitch_calc(y,genesets,priority="effect",cores=2)
```

You can peek at the top results with head like this:

```{r,res_peek}
head(res$enrichment_result)
```

By default, gene sets with fewer than 10 members present in the profiling data are discarded. This threshold can 
be modified using the minsetsize option. There is no upper limit of gene set size.

```{r,calc4,eval=TRUE}
res<-mitch_calc(y,genesets,priority="significance",minsetsize=20,cores=2)
```
By default, in downstream visualisation steps, charts are made from the top 50 gene sets, but this can be 
modified using the resrows option.

```{r,calc5,eval=TRUE}
res<-mitch_calc(y,genesets,priority="significance",resrows=3,cores=2)
```

## Generate a HTML report
Can be done like this:

```{r,report,eval=TRUE,message=FALSE}
mitch_report(res,"myreport.html")
```
If you receive an error here, ensure that Taucharts is installed properly. Take a look at an example report.

## Generate high resolution plots
In case you want the charts in PDF format, these can be generated as such:

```{r,plots,eval=TRUE,message=FALSE}
mitch_plots(res,outfile="mycharts.pdf",cores=2)
```

## Condensed full example
```{r,full_example}
download.file("https://reactome.org/download/current/ReactomePathways.gmt.zip",destfile="ReactomePathways.gmt.zip")
unzip("ReactomePathways.gmt.zip")
genesets<-gmt_import("ReactomePathways.gmt")
head(genesets,3)
dge1<-read.table("https://raw.githubusercontent.com/markziemann/mitch/master/data-raw/LGvHG.tsv",header=TRUE,row.names=1)
dge2<-read.table("https://raw.githubusercontent.com/markziemann/mitch/master/data-raw/HGvHGV.tsv",header=TRUE,row.names=1)
x<-list("dge1"=dge1,"dge2"=dge2)
str(x)
# note that the gene IDs are ensembl accessions and the reactomes are gene symbols
gt<-read.table("https://raw.githubusercontent.com/markziemann/mitch/master/data-raw/gt.tsv",header=TRUE,row.names=1)
y<-mitch_import(x,DEtype="deseq2",geneTable=gt)
head(y)
res<-mitch_calc(y,genesets,priority="significance",cores=2,resrows=3)
head(res$enrichment_result)
mitch_report(res,"myreport2.html")
mitch_plots(res,outfile="mycharts.pdf",cores=2)
```

